from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from pydantic import BaseModel, EmailStr, validator
from typing import List, Optional, Dict
import hashlib
import random
import string
import re
from datetime import datetime, timedelta

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# --- –ú–æ–¥–µ–ª–∏ ---
class UserCreate(BaseModel):
    name: str
    phone: str
    email: EmailStr
    password: str
    birthday: Optional[str] = None

    @validator('phone')
    def validate_phone(cls, v):
        phone = re.sub(r'[\s\-\(\)]', '', v)
        if not re.match(r'^\+7\d{10}$', phone):
            raise ValueError('–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 XXX XXX XX XX')
        return phone

    @validator('password')
    def validate_password(cls, v):
        if len(v) < 6:
            raise ValueError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤')
        return v


class UserLogin(BaseModel):
    identifier: str
    password: str


class User(BaseModel):
    id: int
    name: str
    phone: str
    email: str
    birthday: Optional[str] = None
    favorites: List[int] = []


class MenuItem(BaseModel):
    id: int
    name: str
    category: str
    price: int
    description: str
    image_url: str


class Restaurant(BaseModel):
    id: int
    name: str
    description: str
    address: str
    district: str
    cuisine: List[str]
    schedule: str
    capacity: int
    image_url: str
    floors: int = 1
    menu: List[MenuItem] = []
    has_vip_cabins: bool = False


class Booking(BaseModel):
    id: int
    user_id: int
    restaurant_id: int
    date: str
    time: str
    guests: int
    comment: str
    floor: int
    tables: List[str]
    is_vip: bool = False
    discount: float = 0.0
    total_price: int = 0
    menu_items: Dict[str, int] = {}
    status: str = "active"


class BookingCreate(BaseModel):
    user_id: int
    restaurant_id: int
    date: str
    time: str
    guests: int
    comment: str
    floor: int
    tables: List[str]
    is_vip: bool = False
    menu_items: Dict[str, int] = {}


class BookingUpdate(BaseModel):
    date: Optional[str] = None
    time: Optional[str] = None
    guests: Optional[int] = None
    comment: Optional[str] = None


# --- –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ---
users_db: dict = {}
users: List[User] = []
verification_codes: dict = {}

menu_aroma = [
    MenuItem(id=1, name="–ö–∞–ø—É—á–∏–Ω–æ", category="–ù–∞–ø–∏—Ç–∫–∏", price=1200,
             description="–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π –∫–æ—Ñ–µ —Å –º–æ–ª–æ—á–Ω–æ–π –ø–µ–Ω–æ–π",
             image_url="https://images.unsplash.com/photo-1572442388796-11668a67e53d?w=400"),
    MenuItem(id=2, name="–õ–∞—Ç—Ç–µ", category="–ù–∞–ø–∏—Ç–∫–∏", price=1300, description="–ù–µ–∂–Ω—ã–π –∫–æ—Ñ–µ —Å –º–æ–ª–æ–∫–æ–º",
             image_url="https://images.unsplash.com/photo-1561882468-9110e03e0f78?w=400"),
    MenuItem(id=3, name="–ê–º–µ—Ä–∏–∫–∞–Ω–æ", category="–ù–∞–ø–∏—Ç–∫–∏", price=900, description="–ö—Ä–µ–ø–∫–∏–π —ç—Å–ø—Ä–µ—Å—Å–æ —Å –≤–æ–¥–æ–π",
             image_url="https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?w=400"),
]

menu_luna = [
    MenuItem(id=7, name="–°—Ç–µ–π–∫ –†–∏–±–∞–π", category="–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞", price=8900,
             description="–ú—Ä–∞–º–æ—Ä–Ω–∞—è –≥–æ–≤—è–¥–∏–Ω–∞ 300–≥ —Å –æ–≤–æ—â–∞–º–∏ –≥—Ä–∏–ª—å",
             image_url="https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=400"),
    MenuItem(id=8, name="–ü–∞—Å—Ç–∞ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞", category="–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞", price=3500,
             description="–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏—Ç–∞–ª—å—è–Ω—Å–∫–∞—è –ø–∞—Å—Ç–∞ —Å –±–µ–∫–æ–Ω–æ–º",
             image_url="https://images.unsplash.com/photo-1612874742237-6526221588e3?w=400"),
]

restaurants: List[Restaurant] = [
    Restaurant(
        id=1, name="–ö–æ—Ñ–µ–π–Ω—è Aroma",
        description="–£—é—Ç–Ω–∞—è –∫–æ—Ñ–µ–π–Ω—è –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞",
        address="—É–ª. –ê–±–∞—è, 10", district="–¶–µ–Ω—Ç—Ä",
        cuisine=["–ö–∞—Ñ–µ", "–ï–≤—Ä–æ–ø–µ–π—Å–∫–∞—è"], schedule="09:00-23:00",
        capacity=40,
        image_url="https://images.unsplash.com/photo-1445116572660-236099ec97a0?w=800",
        floors=2, menu=menu_aroma, has_vip_cabins=False
    ),
    Restaurant(
        id=2, name="Restaurant Luna",
        description="–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å –µ–≤—Ä–æ–ø–µ–π—Å–∫–æ–π –∫—É—Ö–Ω–µ–π",
        address="—É–ª. –î–æ—Å—Ç—ã–∫, 5", district="–ú–µ–¥–µ—É",
        cuisine=["–ï–≤—Ä–æ–ø–µ–π—Å–∫–∞—è", "–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è"], schedule="10:00-22:00",
        capacity=50,
        image_url="https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800",
        floors=2, menu=menu_luna, has_vip_cabins=True
    ),
]

bookings: List[Booking] = []
next_user_id = 1
next_booking_id = 1


# --- Helper Functions ---
def format_phone(phone: str) -> str:
    phone = re.sub(r'[\s\-\(\)]', '', phone)
    if not phone.startswith('+'): phone = '+' + phone
    if phone.startswith('+8'): phone = '+7' + phone[2:]
    return phone


def hash_password(password: str) -> str:
    return hashlib.sha256(password.encode()).hexdigest()


def generate_code() -> str:
    return ''.join(random.choices(string.digits, k=6))


def send_email(to_email: str, subject: str, body: str):
    print(f"\n{'=' * 50}\nüìß EMAIL TO: {to_email}\nSUBJECT: {subject}\nBODY:\n{body}\n{'=' * 50}\n")
    return True


def calculate_birthday_discount(birthday: str, booking_date: str) -> float:
    try:
        bday = datetime.strptime(birthday, "%Y-%m-%d")
        book_date = datetime.strptime(booking_date, "%Y-%m-%d")
        if bday.month == book_date.month and bday.day == book_date.day:
            return 5.0
    except:
        pass
    return 0.0


# --- HTML ---
html_content = """<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reserve ‚Äî –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–æ–≤</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --bg: #fafafa; --surface: #fff; --text-primary: #1a1a1a; --text-secondary: #666;
    --accent: #2563eb; --accent-hover: #1d4ed8; --border: #e5e5e5;
    --success: #10b981; --warning: #f59e0b; --error: #ef4444;
}
body { font-family: 'Manrope', sans-serif; background: var(--bg); color: var(--text-primary); line-height: 1.6; }
header { position: fixed; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border); z-index: 100; }
.header-content { max-width: 1400px; margin: 0 auto; padding: 20px 32px; display: flex; justify-content: space-between; align-items: center; }
.logo { font-size: 28px; font-weight: 800; color: var(--accent); cursor: pointer; }
.header-actions { display: flex; gap: 12px; }
nav { display: flex; gap: 8px; }
.btn { padding: 10px 24px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-secondary { background: transparent; color: var(--text-primary); border: 1px solid var(--border); }
nav button { padding: 10px 20px; background: transparent; color: var(--text-secondary); border: none;
    border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
nav button:hover { background: #f5f5f5; color: var(--text-primary); }
nav button.active { background: var(--accent); color: white; }
.container { max-width: 1400px; margin: 100px auto 60px; padding: 0 32px; }
.section { display: none; }
.section.active { display: block; }
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 32px; margin-bottom: 24px; }
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; }
input, select, textarea { width: 100%; padding: 14px 16px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; font-size: 15px; font-family: 'Manrope', sans-serif; transition: all 0.2s; }
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
.restaurant-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 28px; }
.restaurant-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden;
    transition: all 0.3s; cursor: pointer; }
.restaurant-card:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
.restaurant-image { height: 220px; overflow: hidden; }
.restaurant-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
.restaurant-card:hover .restaurant-image img { transform: scale(1.08); }
.restaurant-content { padding: 24px; }
.restaurant-content h3 { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
.badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-right: 8px; }
.badge-cuisine { background: #e0e7ff; color: #3730a3; }
.badge-district { background: #fef3c7; color: #92400e; }
.alert { padding: 16px 20px; border-radius: 10px; margin-bottom: 20px; font-weight: 500; }
.alert-success { background: #d1fae5; color: #065f46; }
.alert-error { background: #fee2e2; color: #991b1b; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin: 20px 0; }
.calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
    border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
.calendar-day:hover:not(.disabled):not(.past) { background: var(--accent); color: white; }
.calendar-day.selected { background: var(--accent); color: white; font-weight: 700; }
.calendar-day.disabled, .calendar-day.past { opacity: 0.3; cursor: not-allowed; }
.time-slots { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin: 20px 0; }
.time-slot { padding: 12px; border: 2px solid var(--border); border-radius: 8px; text-align: center;
    cursor: pointer; transition: all 0.2s; }
.time-slot:hover:not(.unavailable) { border-color: var(--accent); background: #f0f7ff; }
.time-slot.selected { background: var(--accent); color: white; border-color: var(--accent); }
.time-slot.unavailable { opacity: 0.4; cursor: not-allowed; background: #f5f5f5; }
.booking-card { padding: 20px; background: white; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; }
.booking-actions { display: flex; gap: 12px; margin-top: 16px; }
.btn-small { padding: 8px 16px; font-size: 14px; }
.quantity-controls { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg);
    border-radius: 8px; border: 1px solid var(--border); }
.quantity-btn { width: 32px; height: 32px; border: none; background: var(--accent); color: white;
    border-radius: 6px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
.quantity-btn:hover { background: var(--accent-hover); transform: scale(1.1); }
.quantity-display { min-width: 40px; text-align: center; font-weight: 700; font-size: 16px; }
.menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.menu-item { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.menu-item-image { height: 180px; overflow: hidden; }
.menu-item-image img { width: 100%; height: 100%; object-fit: cover; }
.menu-item-content { padding: 16px; }
.menu-item-price { font-size: 20px; font-weight: 700; color: var(--accent); margin-top: 8px; }
.menu-item-actions { display: flex; gap: 8px; margin-top: 12px; align-items: center; }
</style>
</head>
<body>

<header>
<div class="header-content">
<div class="logo" onclick="showSection('welcome')">Reserve</div>
<div class="header-actions" id="header-actions">
    <button class="btn btn-primary" onclick="showSection('restaurants')">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</button>
    <button class="btn btn-secondary" id="auth-btn" onclick="showSection('login')">–í–æ–π—Ç–∏</button>
</div>
</div>
</header>

<div class="container">

<div id="welcome" class="section active">
<div style="text-align: center; padding: 100px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 24px; color: white;">
<h1 style="font-size: 64px; font-weight: 800; margin-bottom: 20px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Reserve</h1>
<p style="font-size: 24px; margin-bottom: 40px;">–õ—É—á—à–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –ê—Å—Ç–∞–Ω—ã –∂–¥—É—Ç –≤–∞—Å</p>
<button class="btn" style="padding: 16px 40px; font-size: 18px; background: white; color: #667eea;"
    onclick="showSection('restaurants')">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã</button>
</div>
</div>

<div id="restaurants" class="section">
<h2 style="font-size: 32px; font-weight: 700; margin-bottom: 24px;">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</h2>
<div class="restaurant-grid" id="restaurant-list"></div>
</div>

<div id="booking" class="section">
<div class="card" style="max-width: 900px; margin: 0 auto;">
<h2 id="booking-title">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
<div id="booking-alert"></div>

<div id="calendar-section">
<h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h3>
<div id="calendar-container"></div>
</div>

<div id="time-section" style="display: none;">
<h3>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</h3>
<div id="time-slots"></div>
</div>

<div class="form-group">
<label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label>
<select id="booking-guests"><option>2</option><option>4</option><option>6</option><option>8</option></select>
</div>

<div class="form-group">
<label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
<textarea id="booking-comment" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
</div>

<div style="display: flex; gap: 12px;">
<button class="btn btn-primary" onclick="proceedToBooking()">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
<button class="btn btn-secondary" onclick="showSection('restaurants')">–ù–∞–∑–∞–¥</button>
</div>
</div>
</div>

<div id="menu-selection" class="section">
<div class="card" style="max-width: 1200px; margin: 0 auto;">
<h2>–ú–µ–Ω—é <span id="menu-restaurant-name"></span></h2>
<p style="color: var(--text-secondary); margin-bottom: 24px;">–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞—Ç—å –±–ª—é–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</p>
<div class="menu-grid" id="menu-grid"></div>
<div style="margin-top: 32px; padding: 24px; background: #f8fafc; border-radius: 12px;">
<h3>–ò—Ç–æ–≥–æ</h3>
<p id="menu-total-text" style="font-size: 24px; font-weight: 700; color: var(--accent);">0 ‚Ç∏</p>
</div>
<div style="display: flex; gap: 12px; margin-top: 24px;">
<button class="btn btn-primary" style="flex: 1;" onclick="confirmBooking()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
<button class="btn btn-secondary" onclick="showSection('booking')">–ù–∞–∑–∞–¥</button>
</div>
</div>
</div>

<div id="history" class="section">
<div class="card">
<h2>–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
<div id="history-list"></div>
</div>
</div>

<div id="login" class="section">
<div class="card" style="max-width: 500px; margin: 0 auto;">
<h2 style="text-align: center;">–í—Ö–æ–¥</h2>
<div id="login-alert"></div>
<div class="form-group"><input id="login-identifier" placeholder="Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω"></div>
<div class="form-group"><input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
<button class="btn btn-primary" style="width: 100%;" onclick="login()">–í–æ–π—Ç–∏</button>
<p style="text-align: center; margin-top: 16px;">
<a href="#" onclick="showSection('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></p>
</div>
</div>

<div id="register" class="section">
<div class="card" style="max-width: 500px; margin: 0 auto;">
<h2 style="text-align: center;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
<div id="register-alert"></div>
<div class="form-group"><input id="reg-name" placeholder="–ò–º—è"></div>
<div class="form-group"><input id="reg-phone" placeholder="+7 XXX XXX XX XX"></div>
<div class="form-group"><input id="reg-email" placeholder="Email"></div>
<div class="form-group"><input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
<div class="form-group"><input type="date" id="reg-birthday"></div>
<button class="btn btn-primary" style="width: 100%;" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
</div>
</div>

</div>

<script>
let currentUser = null;
let currentRestaurant = null;
let selectedDate = null;
let selectedTime = null;
let selectedMenuItems = {};
let allRestaurants = [];
let currentBookingId = null;

async function loadRestaurants() {
    const res = await fetch("/restaurants");
    allRestaurants = await res.json();
    displayRestaurants(allRestaurants);
}

function displayRestaurants(restaurants) {
    const list = document.getElementById('restaurant-list');
    list.innerHTML = restaurants.map(r => `
        <div class="restaurant-card" onclick="openRestaurant(${r.id})">
            <div class="restaurant-image"><img src="${r.image_url}"></div>
            <div class="restaurant-content">
                <h3>${r.name}</h3>
                <div style="margin: 8px 0;">
                    ${r.cuisine.map(c => `<span class="badge badge-cuisine">${c}</span>`).join('')}
                    <span class="badge badge-district">${r.district}</span>
                </div>
                <p style="color: var(--text-secondary); margin: 8px 0;">${r.description}</p>
                <p style="font-size: 13px; color: var(--text-secondary);">üìç ${r.address} ‚Ä¢ üïí ${r.schedule}</p>
            </div>
        </div>
    `).join('');
}

async function openRestaurant(id) {
    const res = await fetch(`/restaurants/${id}`);
    currentRestaurant = await res.json();
    document.getElementById('booking-title').textContent = `–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ${currentRestaurant.name}`;
    renderCalendar();
    showSection('booking');
}

function renderCalendar() {
    const container = document.getElementById('calendar-container');
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    let html = '<div class="calendar-grid">';
    ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].forEach(day => {
        html += `<div style="font-weight: 600; text-align: center;">${day}</div>`;
    });

    const firstDay = new Date(year, month, 1).getDay();
    const offset = firstDay === 0 ? 6 : firstDay - 1;

    for(let i = 0; i < offset; i++) html += '<div></div>';

    for(let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        const isPast = date < new Date().setHours(0,0,0,0);
        const isSelected = dateStr === selectedDate;

        html += `<div class="calendar-day ${isPast ? 'past' : ''} ${isSelected ? 'selected' : ''}" 
                 onclick="${isPast ? '' : `selectDate('${dateStr}')`}">${day}</div>`;
    }
    html += '</div>';
    container.innerHTML = html;
}

async function selectDate(date) {
    selectedDate = date;
    renderCalendar();

    const res = await fetch(`/restaurants/${currentRestaurant.id}/availability?date=${date}`);
    const data = await res.json();

    document.getElementById('time-section').style.display = 'block';

    const slotsContainer = document.getElementById('time-slots');
    slotsContainer.innerHTML = data.slots.map(slot => {
        const isAvailable = slot.available;
        const isSelected = slot.time === selectedTime;
        return `<div class="time-slot ${isAvailable ? '' : 'unavailable'} ${isSelected ? 'selected' : ''}"
                     onclick="${isAvailable ? `selectTime('${slot.time}')` : ''}">
                    ${slot.time}${isAvailable ? '' : '<br><small>–ó–∞–Ω—è—Ç–æ</small>'}
                </div>`;
    }).join('');
}

function selectTime(time) {
    selectedTime = time;
    selectDate(selectedDate);
}

async function proceedToBooking() {
    if(!selectedDate || !selectedTime) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è');
        return;
    }

    if(!currentUser) {
        if(confirm('–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏. –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏?')) {
            showSection('register');
        }
        return;
    }

    document.getElementById('menu-restaurant-name').textContent = currentRestaurant.name;
    const menuGrid = document.getElementById('menu-grid');
    menuGrid.innerHTML = currentRestaurant.menu.map(item => {
        const quantity = selectedMenuItems[item.id] || 0;
        return `<div class="menu-item">
            <div class="menu-item-image"><img src="${item.image_url}"></div>
            <div class="menu-item-content">
                <h4>${item.name}</h4>
                <p style="font-size: 12px; color: var(--text-secondary);">${item.category}</p>
                <p style="font-size: 14px; color: var(--text-secondary); margin: 8px 0;">${item.description}</p>
                <div class="menu-item-price">${item.price.toLocaleString()} ‚Ç∏</div>
                <div class="menu-item-actions">
                    ${quantity > 0 ? `
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateMenuQuantity(${item.id}, ${quantity - 1})">‚àí</button>
                            <div class="quantity-display">${quantity}</div>
                            <button class="quantity-btn" onclick="updateMenuQuantity(${item.id}, ${quantity + 1})">+</button>
                        </div>
                    ` : `
                        <button class="btn btn-primary btn-small" onclick="updateMenuQuantity(${item.id}, 1)" style="width: 100%;">
                            + –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    `}
                </div>
            </div>
        </div>`;
    }).join('');

    updateMenuTotal();
    showSection('menu-selection');
}

function updateMenuQuantity(itemId, quantity) {
    if(quantity <= 0) delete selectedMenuItems[itemId];
    else selectedMenuItems[itemId] = quantity;
    proceedToBooking();
}

function updateMenuTotal() {
    let total = 0;
    for(const [itemId, quantity] of Object.entries(selectedMenuItems)) {
        const item = currentRestaurant.menu.find(m => m.id === parseInt(itemId));
        if(item) total += item.price * quantity;
    }
    document.getElementById('menu-total-text').textContent = `${Math.round(total).toLocaleString()} ‚Ç∏`;
}

async function confirmBooking() {
    const bookingData = {
        user_id: currentUser.id,
        restaurant_id: currentRestaurant.id,
        date: selectedDate,
        time: selectedTime,
        guests: parseInt(document.getElementById('booking-guests').value),
        comment: document.getElementById('booking-comment').value || '',
        floor: 1,
        tables: ["1-1"],
        menu_items: selectedMenuItems
    };

    const res = await fetch(currentBookingId ? `/bookings/${currentBookingId}` : "/bookings", {
        method: currentBookingId ? "PUT" : "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(bookingData)
    });

    if(res.ok) {
        alert(currentBookingId ? '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!' : '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
        currentBookingId = null;
        selectedMenuItems = {};
        loadHistory();
        showSection('history');
    }
}

async function register() {
    const data = {
        name: document.getElementById('reg-name').value,
        phone: document.getElementById('reg-phone').value,
        email: document.getElementById('reg-email').value,
        password: document.getElementById('reg-password').value,
        birthday: document.getElementById('reg-birthday').value
    };

    const res = await fetch("/register", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    if(res.ok) {
        currentUser = await res.json();
        updateHeader();
        showSection('restaurants');
    } else {
        const error = await res.json();
        document.getElementById('register-alert').innerHTML = `<div class="alert alert-error">${error.detail}</div>`;
    }
}

async function login() {
    const data = {
        identifier: document.getElementById('login-identifier').value,
        password: document.getElementById('login-password').value
    };

    const res = await fetch("/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    if(res.ok) {
        currentUser = await res.json();
        updateHeader();
        showSection('restaurants');
    } else {
        document.getElementById('login-alert').innerHTML = '<div class="alert alert-error">–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>';
    }
}

function updateHeader() {
    const btn = document.getElementById('auth-btn');
    if(currentUser) {
        btn.textContent = '–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è';
        btn.onclick = () => { loadHistory(); showSection('history'); };
    } else {
        btn.textContent = '–í–æ–π—Ç–∏';
        btn.onclick = () => showSection('login');
    }
}

async function loadHistory() {
    if(!currentUser) return;

    const res = await fetch("/bookings");
    const bookings = await res.json();
    const userBookings = bookings.filter(b => b.user_id === currentUser.id);

    const list = document.getElementById('history-list');
    list.innerHTML = userBookings.map(b => {
        const rest = allRestaurants.find(r => r.id === b.restaurant_id);
        return `<div class="booking-card">
            <h3>${rest?.name || '–†–µ—Å—Ç–æ—Ä–∞–Ω'}</h3>
            <p>üìÖ ${b.date} –≤ ${b.time} ‚Ä¢ üë• ${b.guests} –≥–æ—Å—Ç–µ–π</p>
            <p>–°—Ç–∞—Ç—É—Å: ${b.status === 'active' ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–æ' : '‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ'}</p>
            ${b.status === 'active' ? `
                <div class="booking-actions">
                    <button class="btn btn-primary btn-small" onclick="editBooking(${b.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    <button class="btn btn-secondary btn-small" onclick="cancelBooking(${b.id})">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                </div>
            ` : ''}
        </div>`;
    }).join('');
}

async function editBooking(id) {
    currentBookingId = id;
    const res = await fetch(`/bookings/${id}`);
    const booking = await res.json();

    selectedDate = booking.date;
    selectedTime = booking.time;
    selectedMenuItems = booking.menu_items || {};
    document.getElementById('booking-guests').value = booking.guests;
    document.getElementById('booking-comment').value = booking.comment;

    await openRestaurant(booking.restaurant_id);
}

async function cancelBooking(id) {
    if(!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) return;
    await fetch(`/bookings/${id}`, { method: "DELETE" });
    loadHistory();
}

function showSection(section) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(section).classList.add('active');
    if(section === 'restaurants') loadRestaurants();
}

loadRestaurants();
</script>
</body>
</html>
"""


# --- Endpoints ---
@app.get("/", response_class=HTMLResponse)
def get_home():
    return HTMLResponse(content=html_content, status_code=200)


@app.post("/register")
def register_user(user: UserCreate):
    global next_user_id
    formatted_phone = format_phone(user.phone)

    if user.email in users_db:
        raise HTTPException(status_code=400, detail="Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")
    if formatted_phone in users_db:
        raise HTTPException(status_code=400, detail="–¢–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")

    password_hash = hash_password(user.password)
    new_user = User(id=next_user_id, name=user.name, phone=formatted_phone,
                    email=user.email, birthday=user.birthday, favorites=[])

    user_data = {"password_hash": password_hash, "user": new_user}
    users_db[user.email] = user_data
    users_db[formatted_phone] = user_data
    users.append(new_user)
    next_user_id += 1

    code = generate_code()
    verification_codes[user.email] = code
    send_email(user.email, "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Reserve!",
               f"–ö–æ–¥: {code}\n–õ–æ–≥–∏–Ω: {user.email} –∏–ª–∏ {formatted_phone}")

    return new_user


@app.post("/login")
def login_user(credentials: UserLogin):
    identifier = credentials.identifier.strip()
    if identifier.startswith('+') or identifier.startswith('7') or identifier.startswith('8'):
        identifier = format_phone(identifier)

    user_data = users_db.get(identifier)
    if not user_data:
        raise HTTPException(status_code=401, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    if user_data["password_hash"] != hash_password(credentials.password):
        raise HTTPException(status_code=401, detail="–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")

    return user_data["user"]


@app.get("/restaurants", response_model=List[Restaurant])
def get_restaurants():
    return restaurants


@app.get("/restaurants/{restaurant_id}", response_model=Restaurant)
def get_restaurant(restaurant_id: int):
    for r in restaurants:
        if r.id == restaurant_id:
            return r
    raise HTTPException(status_code=404, detail="–†–µ—Å—Ç–æ—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")


@app.get("/restaurants/{restaurant_id}/availability")
def get_availability(restaurant_id: int, date: str):
    restaurant = next((r for r in restaurants if r.id == restaurant_id), None)
    if not restaurant:
        raise HTTPException(status_code=404, detail="–†–µ—Å—Ç–æ—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")

    day_bookings = [b for b in bookings if b.restaurant_id == restaurant_id
                    and b.date == date and b.status == "active"]

    slots = []
    for h in range(9, 23):
        for m in ["00", "30"]:
            if h == 22 and m == "30": continue
            time_slot = f"{h:02d}:{m}"

            booked_count = sum(1 for b in day_bookings if b.time == time_slot)
            slots.append({
                "time": time_slot,
                "available": booked_count < restaurant.capacity // 10
            })

    return {"date": date, "slots": slots}


@app.post("/bookings", response_model=Booking)
def create_booking(b: BookingCreate):
    global next_booking_id

    total_price = 0
    restaurant = next((r for r in restaurants if r.id == b.restaurant_id), None)
    if restaurant and b.menu_items:
        for item_id, quantity in b.menu_items.items():
            menu_item = next((m for m in restaurant.menu if m.id == int(item_id)), None)
            if menu_item:
                total_price += menu_item.price * quantity

    user = next((u for u in users if u.id == b.user_id), None)
    discount = 0
    if user and user.birthday:
        discount = calculate_birthday_discount(user.birthday, b.date)
        if discount > 0:
            total_price = int(total_price * (1 - discount / 100))

    booking = Booking(
        id=next_booking_id, user_id=b.user_id, restaurant_id=b.restaurant_id,
        date=b.date, time=b.time, guests=b.guests, comment=b.comment,
        floor=b.floor, tables=b.tables, is_vip=b.is_vip,
        discount=discount, total_price=total_price, menu_items=b.menu_items,
        status="active"
    )

    bookings.append(booking)
    next_booking_id += 1

    if user and restaurant:
        send_email(user.email, "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ",
                   f"–ë—Ä–æ–Ω—å #{booking.id}\n{restaurant.name}\n{b.date} –≤ {b.time}")

    return booking


@app.get("/bookings", response_model=List[Booking])
def list_bookings():
    return bookings


@app.get("/bookings/{booking_id}", response_model=Booking)
def get_booking(booking_id: int):
    booking = next((b for b in bookings if b.id == booking_id), None)
    if not booking:
        raise HTTPException(status_code=404, detail="–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    return booking


@app.put("/bookings/{booking_id}")
def update_booking(booking_id: int, updates: BookingUpdate):
    booking = next((b for b in bookings if b.id == booking_id), None)
    if not booking:
        raise HTTPException(status_code=404, detail="–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

    if booking.status != "active":
        raise HTTPException(status_code=400, detail="–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")

    booking_datetime = datetime.strptime(f"{booking.date} {booking.time}", "%Y-%m-%d %H:%M")
    if booking_datetime < datetime.now():
        raise HTTPException(status_code=400, detail="–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—à–µ–¥—à–µ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ")

    if updates.date: booking.date = updates.date
    if updates.time: booking.time = updates.time
    if updates.guests: booking.guests = updates.guests
    if updates.comment is not None: booking.comment = updates.comment

    user = next((u for u in users if u.id == booking.user_id), None)
    restaurant = next((r for r in restaurants if r.id == booking.restaurant_id), None)
    if user and restaurant:
        send_email(user.email, "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ",
                   f"–ë—Ä–æ–Ω—å #{booking.id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞\n{restaurant.name}\n{booking.date} –≤ {booking.time}")

    return booking


@app.delete("/bookings/{booking_id}")
def cancel_booking(booking_id: int):
    booking = next((b for b in bookings if b.id == booking_id), None)
    if not booking:
        raise HTTPException(status_code=404, detail="–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")

    booking.status = "cancelled"

    user = next((u for u in users if u.id == booking.user_id), None)
    restaurant = next((r for r in restaurants if r.id == booking.restaurant_id), None)
    if user and restaurant:
        send_email(user.email, "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ",
                   f"–ë—Ä–æ–Ω—å #{booking.id} –æ—Ç–º–µ–Ω–µ–Ω–∞\n{restaurant.name}\n{booking.date} –≤ {booking.time}")

    return {"message": "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ", "booking_id": booking_id}
