<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reserve ‚Äî –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–æ–≤</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --bg: #fafafa;
    --surface: #ffffff;
    --text-primary: #1a1a1a;
    --text-secondary: #666666;
    --text-muted: #999999;
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --border: #e5e5e5;
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.08);
}

body {
    font-family: 'Manrope', sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    line-height: 1.6;
}

header {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    z-index: 100;
    animation: slideDown 0.4s ease;
}
@keyframes slideDown {
    from { transform: translateY(-100%); }
    to { transform: translateY(0); }
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    font-size: 28px;
    font-weight: 800;
    color: var(--accent);
    letter-spacing: -0.5px;
    cursor: pointer;
}

.header-actions { display: flex; gap: 12px; }
nav { display: flex; gap: 8px; }

.btn {
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    font-family: 'Manrope', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
.btn-secondary { background: transparent; color: var(--text-primary); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

nav button {
    padding: 10px 20px;
    background: transparent;
    color: var(--text-secondary);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-family: 'Manrope', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
}
nav button:hover { background: #f5f5f5; color: var(--text-primary); }
nav button.active { background: var(--accent); color: white; }

.container {
    max-width: 1400px;
    margin: 100px auto 60px;
    padding: 0 32px;
}

.section { display: none; animation: fadeIn 0.3s ease; }
.section.active { display: block; }
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.welcome-hero {
    text-align: center;
    padding: 100px 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 24px;
    color: white;
    margin-bottom: 60px;
}
.welcome-hero h1 { font-size: 64px; font-weight: 800; margin-bottom: 20px; letter-spacing: -2px; }
.welcome-hero p { font-size: 24px; opacity: 0.9; margin-bottom: 40px; }
.welcome-actions { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
.btn-large { padding: 16px 40px; font-size: 18px; }
.btn-white { background: white; color: var(--accent); }
.btn-white:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.2); }

.card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 24px;
    box-shadow: var(--shadow-sm);
}

.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; }
input, select, textarea {
    width: 100%;
    padding: 14px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 15px;
    font-family: 'Manrope', sans-serif;
    transition: all 0.2s;
}
input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.filters {
    background: white;
    padding: 24px;
    border-radius: 16px;
    border: 1px solid var(--border);
    margin-bottom: 32px;
}
.filter-group { margin-bottom: 16px; }
.filter-group:last-child { margin-bottom: 0; }
.filter-label { font-size: 14px; font-weight: 600; margin-bottom: 8px; display: block; }

.restaurant-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 28px;
}

.restaurant-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.3s;
}
.restaurant-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); }

.restaurant-image { position: relative; height: 220px; overflow: hidden; }
.restaurant-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
.restaurant-card:hover .restaurant-image img { transform: scale(1.08); }

.fav-btn {
    position: absolute; top: 14px; right: 14px;
    width: 38px; height: 38px;
    background: rgba(255,255,255,0.92); border: none; border-radius: 50%;
    cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; backdrop-filter: blur(8px); z-index: 2;
}
.fav-btn:hover { transform: scale(1.15); }

.restaurant-content { padding: 24px; }
.restaurant-content h3 { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
.restaurant-badges { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.badge-cuisine { background: #e0e7ff; color: #3730a3; }
.badge-district { background: #fef3c7; color: #92400e; }
.badge-vip { background: #fce7f3; color: #9f1239; }

.branch-select-label { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; }
.branch-options { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
.branch-option {
    padding: 9px 14px; border: 1px solid var(--border); border-radius: 8px;
    font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.18s;
    background: var(--bg); text-align: left; color: var(--text-secondary);
    font-family: 'Manrope', sans-serif;
}
.branch-option:hover { border-color: var(--accent); color: var(--accent); background: #eff6ff; }

.floor-plan {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 32px; border-radius: 16px; margin: 24px 0;
}
.floor-tabs { display: flex; gap: 12px; margin-bottom: 24px; justify-content: center; }
.floor-tab {
    padding: 12px 24px; border: 2px solid var(--border); background: white;
    border-radius: 10px; cursor: pointer; font-weight: 600;
    font-family: 'Manrope', sans-serif; transition: all 0.2s;
}
.floor-tab.active { border-color: var(--accent); background: var(--accent); color: white; }

.tables-container {
    background: white; padding: 40px; border-radius: 12px;
    position: relative; min-height: 500px;
}

.table-item { position: absolute; cursor: pointer; transition: all 0.3s; }
.table-visual { position: relative; display: flex; align-items: center; justify-content: center; }
.table-shape {
    background: linear-gradient(145deg, #e2e8f0, #cbd5e1);
    border: 3px solid #94a3b8;
    box-shadow: 4px 4px 12px rgba(0,0,0,0.15);
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; transition: all 0.3s;
}
.table-item:hover .table-shape { transform: scale(1.1); box-shadow: 6px 6px 16px rgba(0,0,0,0.2); }
.table-item.selected .table-shape {
    background: linear-gradient(145deg, #10b981, #059669);
    border-color: #047857; color: white; animation: pulse 1s infinite;
}
.table-item.occupied .table-shape {
    background: linear-gradient(145deg, #fca5a5, #f87171);
    border-color: #dc2626; opacity: 0.6; cursor: not-allowed;
}
.table-item.vip .table-shape {
    background: linear-gradient(145deg, #fbbf24, #f59e0b);
    border-color: #d97706; box-shadow: 0 0 20px rgba(251,191,36,0.4);
}
.table-item.vip.selected .table-shape {
    background: linear-gradient(145deg, #a855f7, #9333ea); border-color: #7e22ce;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.window-marker {
    position: absolute; padding: 6px 12px;
    background: #dbeafe; color: #1e40af;
    border-radius: 6px; font-size: 12px; font-weight: 600; border: 2px solid #60a5fa;
}

.selected-tables-display {
    background: #f0fdf4; border: 2px solid #10b981;
    border-radius: 10px; padding: 16px; margin: 16px 0;
}
.selected-table-tag {
    display: inline-block; padding: 6px 12px;
    background: var(--accent); color: white;
    border-radius: 6px; margin: 4px; font-size: 14px;
}

.menu-categories { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.cat-btn {
    padding: 8px 18px; border: 1px solid var(--border); border-radius: 20px;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.18s;
    background: transparent; color: var(--text-secondary); font-family: 'Manrope', sans-serif;
}
.cat-btn:hover { border-color: var(--accent); color: var(--accent); }
.cat-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

.menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px; margin-top: 20px;
}
.menu-item {
    background: white; border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden; transition: all 0.2s;
}
.menu-item:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
.menu-item.in-cart { border-color: var(--success); }
.menu-item-image { height: 180px; overflow: hidden; }
.menu-item-image img { width: 100%; height: 100%; object-fit: cover; }
.menu-item-content { padding: 16px; }
.menu-item-content h4 { font-size: 18px; margin-bottom: 4px; }
.menu-item-category { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
.menu-item-price { font-size: 20px; font-weight: 700; color: var(--accent); margin-top: 8px; }

.qty-control {
    display: flex; align-items: center; border: 1px solid var(--border);
    border-radius: 8px; overflow: hidden; margin-top: 12px; background: var(--bg);
}
.qty-btn {
    width: 36px; height: 36px; border: none; background: transparent;
    font-size: 20px; font-weight: 700; cursor: pointer; color: var(--text-secondary);
    transition: all 0.15s; display: flex; align-items: center; justify-content: center;
    font-family: 'Manrope', sans-serif;
}
.qty-btn:hover { background: var(--accent); color: white; }
.qty-count { flex: 1; text-align: center; font-size: 15px; font-weight: 700; }
.btn-add-menu {
    width: 100%; padding: 10px; background: var(--accent); color: white;
    border: none; border-radius: 8px; font-size: 14px; font-weight: 600;
    cursor: pointer; margin-top: 12px; font-family: 'Manrope', sans-serif; transition: all 0.2s;
}
.btn-add-menu:hover { background: var(--accent-hover); }

.order-summary-box {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px 24px; margin-top: 28px;
}
.order-line {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 14px;
}
.order-line:last-child { border-bottom: none; font-weight: 700; font-size: 18px; padding-top: 12px; }

.alert { padding: 16px 20px; border-radius: 10px; margin-bottom: 20px; font-weight: 500; }
.alert-success { background: #d1fae5; color: #065f46; }
.alert-error { background: #fee2e2; color: #991b1b; }

.booking-card {
    padding: 20px; background: white; border: 1px solid var(--border);
    border-radius: 12px; margin-bottom: 16px; transition: all 0.2s;
}
.booking-card:hover { box-shadow: var(--shadow-md); }
.booking-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.booking-card-title { font-size: 18px; font-weight: 700; }
.booking-tag { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.tag-upcoming { background: #d1fae5; color: #065f46; }
.tag-past { background: #f3f4f6; color: var(--text-muted); }

.confirm-circle {
    width: 80px; height: 80px; margin: 0 auto 24px;
    background: var(--success); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 40px; color: white;
}

.profile-avatar {
    width: 100px; height: 100px; margin: 0 auto 20px;
    background: var(--accent); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 40px; font-weight: 700; color: white;
}
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
.stat-box { background: var(--bg); border-radius: 10px; padding: 16px; text-align: center; }
.stat-val { font-size: 28px; font-weight: 800; color: var(--accent); }
.stat-lbl { font-size: 12px; color: var(--text-muted); font-weight: 600; margin-top: 4px; }

.toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--text-primary); color: white;
    padding: 14px 22px; border-radius: 12px; font-size: 14px; font-weight: 600;
    z-index: 9999; transform: translateY(80px); opacity: 0;
    transition: all 0.3s ease; pointer-events: none; box-shadow: var(--shadow-lg);
}
.toast.show { transform: translateY(0); opacity: 1; }

.delete-btn {
    background: var(--error);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.delete-btn:hover {
    background: #dc2626;
    transform: translateY(-2px);
}
.delete-btn:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.5;
    transform: none;
}

@media (max-width: 768px) {
    .welcome-hero h1 { font-size: 36px; }
    .restaurant-grid { grid-template-columns: 1fr; }
    .menu-grid { grid-template-columns: 1fr; }
    .header-content { flex-direction: column; gap: 12px; }
    .container { padding: 0 16px; margin-top: 160px; }
}
</style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="logo" onclick="showSection('welcome')">Reserve</div>
        <div class="header-actions" id="header-actions-guest">
            <button class="btn btn-secondary" onclick="showSection('login')">–í–æ–π—Ç–∏</button>
            <button class="btn btn-primary" onclick="showSection('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button class="btn btn-primary" onclick="checkAuthAndBook()">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div class="header-actions" id="header-actions-user" style="display:none;">
            <nav>
                <button id="nav-restaurants" onclick="showSection('restaurants')">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</button>
                <button id="nav-history" onclick="showSection('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
                <button id="nav-favorites" onclick="showSection('favorites')">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                <button id="nav-profile" onclick="showSection('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
            </nav>
            <button class="btn btn-secondary" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</header>

<div id="toast" class="toast"></div>

<div class="container">

<!-- Welcome -->
<div id="welcome" class="section active">
    <div class="welcome-hero">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Reserve</h1>
        <p>–õ—É—á—à–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –ê—Å—Ç–∞–Ω—ã –∂–¥—É—Ç –≤–∞—Å</p>
        <div class="welcome-actions">
            <button class="btn btn-large btn-white" onclick="showSection('register')">–ù–∞—á–∞—Ç—å</button>
            <button class="btn btn-large btn-primary" onclick="showSection('login')">–í–æ–π—Ç–∏</button>
        </div>
    </div>
</div>

<!-- Login -->
<div id="login" class="section">
    <div class="card" style="max-width:500px;margin:0 auto;">
        <h2 style="font-size:28px;font-weight:700;margin-bottom:24px;text-align:center;">–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
        <div id="login-alert"></div>
        <div class="form-group">
            <label class="form-label">Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω</label>
            <input id="login-identifier" placeholder="example@email.com –∏–ª–∏ +7..." onkeydown="if(event.key==='Enter')login()">
        </div>
        <div class="form-group">
            <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter')login()">
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="login()">–í–æ–π—Ç–∏</button>
        <p style="text-align:center;margin-top:16px;color:var(--text-secondary);">
            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="showSection('register')" style="color:var(--accent);">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>
        </p>
    </div>
</div>

<!-- Register -->
<div id="register" class="section">
    <div class="card" style="max-width:500px;margin:0 auto;">
        <h2 style="font-size:28px;font-weight:700;margin-bottom:24px;text-align:center;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <div id="register-alert"></div>
        <div class="form-group">
            <label class="form-label">–ü–æ–ª–Ω–æ–µ –∏–º—è *</label>
            <input id="reg-name" placeholder="–í–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è">
        </div>
        <div class="form-group">
            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input id="reg-phone" placeholder="+7 XXX XXX XX XX" maxlength="16" oninput="formatPhoneInput(this)">
            <small style="color:var(--text-muted);font-size:12px;">–§–æ—Ä–º–∞—Ç: +7 777 123 45 67</small>
        </div>
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" id="reg-email" placeholder="example@email.com">
            <small style="color:var(--text-muted);font-size:12px;">–•–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ (—Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</small>
        </div>
        <div class="form-group">
            <label class="form-label">–ü–∞—Ä–æ–ª—å *</label>
            <input type="password" id="reg-password" placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤: –±—É–∫–≤–∞ + —Ü–∏—Ñ—Ä–∞">
            <small style="color:var(--text-muted);font-size:12px;">–ú–∏–Ω. 8 —Å–∏–º–≤–æ–ª–æ–≤, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤, —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –±—É–∫–≤–∞ –∏ –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞</small>
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <p style="text-align:center;margin-top:16px;color:var(--text-secondary);">
            –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="showSection('login')" style="color:var(--accent);">–í–æ–π–¥–∏—Ç–µ</a>
        </p>
    </div>
</div>

<!-- Restaurants -->
<div id="restaurants" class="section">
    <h2 style="font-size:32px;font-weight:700;margin-bottom:24px;">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</h2>
    <div class="filters">
        <div class="filter-group">
            <label class="filter-label">–ü–æ–∏—Å–∫</label>
            <input id="search-input" placeholder="üîç –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞..." oninput="filterRestaurants()">
        </div>
    </div>
    <div class="restaurant-grid" id="restaurant-list"></div>
</div>

<!-- Booking -->
<div id="booking" class="section">
    <div class="card" style="max-width:1000px;margin:0 auto;">
        <h2 style="font-size:28px;font-weight:700;margin-bottom:6px;" id="booking-title">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
        <p style="color:var(--text-secondary);margin-bottom:24px;font-size:14px;" id="booking-branch-info"></p>
        <div id="booking-alert"></div>

        <div class="form-group">
            <label class="form-label">–î–∞—Ç–∞</label>
            <input type="date" id="booking-date">
        </div>
        <div class="form-group">
            <label class="form-label">–í—Ä–µ–º—è</label>
            <select id="booking-time"></select>
        </div>
        <div class="form-group">
            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label>
            <select id="booking-guests">
                <option>1</option><option>2</option><option selected>4</option>
                <option>6</option><option>8</option><option>10</option><option>12</option>
            </select>
        </div>

        <div class="floor-plan">
            <h3 style="text-align:center;margin-bottom:20px;font-size:20px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–∏–∫–∏</h3>
            <div class="floor-tabs" id="floor-tabs"></div>
            <div class="tables-container" id="tables-container"></div>
            <div style="text-align:center;margin-top:16px;font-size:13px;color:var(--text-secondary);">
                <span style="color:var(--success);">‚ñ† –í—ã–±—Ä–∞–Ω–æ</span>
                <span style="margin:0 16px;color:var(--text-muted);">‚ñ† –°–≤–æ–±–æ–¥–Ω–æ</span>
                <span style="color:var(--error);">‚ñ† –ó–∞–Ω—è—Ç–æ</span>
                <span style="margin:0 16px;color:var(--warning);">‚ñ† VIP</span>
            </div>
        </div>

        <div id="selected-tables-info"></div>

        <div class="form-group">
            <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea id="booking-comment" rows="3" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
        </div>

        <div style="display:flex;gap:12px;">
            <button class="btn btn-primary" style="flex:1;" onclick="proceedToMenu()">–î–∞–ª–µ–µ: –ú–µ–Ω—é</button>
            <button class="btn btn-secondary" onclick="showSection('restaurants')">–ù–∞–∑–∞–¥</button>
        </div>
    </div>
</div>

<!-- Menu Selection -->
<div id="menu-selection" class="section">
    <div class="card" style="max-width:1200px;margin:0 auto;">
        <h2 style="font-size:28px;font-weight:700;margin-bottom:8px;">–ú–µ–Ω—é <span id="menu-restaurant-name"></span></h2>
        <p style="color:var(--text-secondary);margin-bottom:24px;">–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞—Ç—å –±–ª—é–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</p>

        <div class="menu-categories" id="menu-categories"></div>
        <div class="menu-grid" id="menu-grid"></div>

        <div class="order-summary-box" id="order-summary" style="display:none;">
            <h3 style="font-size:18px;font-weight:700;margin-bottom:14px;">–í–∞—à –ø—Ä–µ–¥–∑–∞–∫–∞–∑</h3>
            <div id="order-lines"></div>
        </div>

        <div style="display:flex;gap:12px;margin-top:24px;">
            <button class="btn btn-primary" style="flex:1;" onclick="confirmBooking()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <button class="btn btn-secondary" onclick="showSection('booking')">–ù–∞–∑–∞–¥</button>
        </div>
    </div>
</div>

<!-- Confirmation -->
<div id="confirmation" class="section">
    <div class="card" style="max-width:700px;margin:0 auto;text-align:center;">
        <div class="confirm-circle">‚úì</div>
        <h2 style="font-size:32px;font-weight:700;margin-bottom:12px;">–ë—Ä–æ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!</h2>
        <p style="color:var(--text-secondary);margin-bottom:24px;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É</p>
        <div style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:24px;text-align:left;">
            <div id="confirmation-details"></div>
        </div>
        <button class="btn btn-primary" onclick="showSection('restaurants')" style="margin-top:24px;">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º</button>
    </div>
</div>

<!-- History -->
<div id="history" class="section">
    <h2 style="font-size:32px;font-weight:700;margin-bottom:24px;">–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h2>
    <div id="history-list"></div>
</div>

<!-- Favorites -->
<div id="favorites" class="section">
    <h2 style="font-size:32px;font-weight:700;margin-bottom:24px;">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
    <div class="restaurant-grid" id="favorites-list"></div>
</div>

<!-- Profile -->
<div id="profile" class="section">
    <div class="card" style="max-width:600px;margin:0 auto;">
        <div id="profile-info"></div>
    </div>
</div>

</div>

<script>
let currentUser = null;
let currentRestaurant = null;
let currentBranchId = null;
let selectedFloor = 1;
let selectedTables = [];
let menuQuantities = {};
let allRestaurants = [];
let occupiedTables = ['1-3', '1-8', '2-5'];
let currentMenuCategory = 'all';

function formatPhoneInput(input) {
    let v = input.value.replace(/\D/g, '');
    if(v.length > 0 && !v.startsWith('7')) v = v.startsWith('8') ? '7'+v.substring(1) : '7'+v;
    if(v.length > 11) v = v.substring(0, 11);
    let f = '+';
    if(v.length > 0) {
        f += v.substring(0,1);
        if(v.length > 1) f += ' '+v.substring(1,4);
        if(v.length > 4) f += ' '+v.substring(4,7);
        if(v.length > 7) f += ' '+v.substring(7,9);
        if(v.length > 9) f += ' '+v.substring(9,11);
    }
    input.value = f;
}

function showToast(msg, dur=2800) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), dur);
}

function showSection(section) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(section).classList.add('active');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    const nb = document.getElementById('nav-' + section);
    if(nb) nb.classList.add('active');
    if(section === 'restaurants' && currentUser) loadRestaurants();
    if(section === 'history' && currentUser) loadHistory();
    if(section === 'favorites' && currentUser) loadFavorites();
    if(section === 'profile' && currentUser) loadProfile();
    window.scrollTo(0, 0);
}

function checkAuthAndBook() {
    if(!currentUser) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
        showSection('register');
    } else {
        showSection('restaurants');
    }
}

async function register() {
    const name = document.getElementById('reg-name').value.trim();
    let phone = document.getElementById('reg-phone').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;
    const alertDiv = document.getElementById('register-alert');
    alertDiv.innerHTML = '';

    if(!name) { alertDiv.innerHTML = '<div class="alert alert-error">–ü–æ–ª–Ω–æ–µ –∏–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</div>'; return; }
    if(!email && !phone) { alertDiv.innerHTML = '<div class="alert alert-error">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω</div>'; return; }
    if(password.length < 8) { alertDiv.innerHTML = '<div class="alert alert-error">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</div>'; return; }
    if(password.includes(' ')) { alertDiv.innerHTML = '<div class="alert alert-error">–ü–∞—Ä–æ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã</div>'; return; }
    if(!/[a-zA-Z]/.test(password)) { alertDiv.innerHTML = '<div class="alert alert-error">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –±—É–∫–≤—É</div>'; return; }
    if(!/[0-9]/.test(password)) { alertDiv.innerHTML = '<div class="alert alert-error">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É</div>'; return; }

    if(phone) {
        phone = phone.replace(/[\s\-\(\)]/g, '');
        if(!phone.startsWith('+')) phone = '+' + phone;
        if(phone.startsWith('+8')) phone = '+7' + phone.substring(2);
        if(!/^\+7\d{10}$/.test(phone)) {
            alertDiv.innerHTML = '<div class="alert alert-error">–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 XXX XXX XX XX</div>';
            return;
        }
    }

    try {
        const body = { name, password };
        if(email) body.email = email;
        if(phone) body.phone = phone;
        const res = await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        if(!res.ok) {
            const err = await res.json();
            let msg = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
            if(typeof err.detail === 'string') msg = err.detail;
            else if(Array.isArray(err.detail)) msg = err.detail.map(e => e.msg||'').join(', ');
            alertDiv.innerHTML = `<div class="alert alert-error">${msg}</div>`;
            return;
        }
        const data = await res.json();
        currentUser = data;
        setLoggedIn(true);
        alertDiv.innerHTML = '<div class="alert alert-success">‚úì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</div>';
        setTimeout(() => { loadRestaurants(); showSection('restaurants'); }, 2000);
    } catch(e) {
        alertDiv.innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</div>';
    }
}

async function login() {
    const identifier = document.getElementById('login-identifier').value.trim();
    const password = document.getElementById('login-password').value;
    const alertDiv = document.getElementById('login-alert');
    alertDiv.innerHTML = '';
    if(!identifier || !password) { alertDiv.innerHTML = '<div class="alert alert-error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è</div>'; return; }
    try {
        const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({identifier, password}) });
        if(!res.ok) {
            const err = await res.json();
            alertDiv.innerHTML = `<div class="alert alert-error">${err.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'}</div>`;
            return;
        }
        const data = await res.json();
        currentUser = data;
        setLoggedIn(true);
        loadRestaurants();
        showSection('restaurants');
    } catch(e) {
        alertDiv.innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞</div>';
    }
}

function logout() {
    currentUser = null; selectedTables = []; menuQuantities = {};
    setLoggedIn(false);
    showSection('welcome');
}

function setLoggedIn(state) {
    document.getElementById('header-actions-guest').style.display = state ? 'none' : 'flex';
    document.getElementById('header-actions-user').style.display = state ? 'flex' : 'none';
}

async function loadRestaurants() {
    try {
        const res = await fetch('/restaurants');
        allRestaurants = await res.json();
        if(currentUser) {
            const fRes = await fetch(`/favorites/${currentUser.id}`);
            const fData = await fRes.json();
            currentUser.favorites = fData.favorites;
        }
        filterRestaurants();
    } catch(e) { console.error(e); }
}

function filterRestaurants() {
    const q = (document.getElementById('search-input')?.value || '').toLowerCase();
    const filtered = allRestaurants.filter(r => {
        return r.name.toLowerCase().includes(q) || r.description.toLowerCase().includes(q);
    });
    displayRestaurants(filtered, 'restaurant-list');
}

function displayRestaurants(list, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    if(!list.length) {
        container.innerHTML = '<p style="text-align:center;padding:40px;color:var(--text-secondary);">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
        return;
    }
    list.forEach(r => {
        const isFav = currentUser?.favorites?.includes(r.id);
        const cuisineBadges = r.cuisine.map(c => `<span class="badge badge-cuisine">${c}</span>`).join('');
        const districts = [...new Set(r.branches.map(b => b.district))];
        const distBadges = districts.map(d => `<span class="badge badge-district">${d}</span>`).join('');
        const vipBadge = r.has_vip_cabins ? '<span class="badge badge-vip">VIP –ö–∞–±–∏–Ω—ã</span>' : '';
        const branchOpts = r.branches.map(b =>
            `<button class="branch-option" onclick="selectBranchAndBook(${r.id},${b.id},event)">üìç ${b.address}</button>`
        ).join('');

        const card = document.createElement('div');
        card.className = 'restaurant-card';
        card.innerHTML = `
            <div class="restaurant-image">
                <img src="${r.image_url}" alt="${r.name}" loading="lazy">
                <button class="fav-btn" onclick="toggleFavorite(${r.id},event)">${isFav ? '‚ù§Ô∏è' : 'ü§ç'}</button>
            </div>
            <div class="restaurant-content">
                <h3>${r.name}</h3>
                <div class="restaurant-badges">${cuisineBadges}${distBadges}${vipBadge}</div>
                <p style="color:var(--text-secondary);font-size:14px;margin-bottom:12px;">${r.description}</p>
                <p style="font-size:13px;color:var(--text-muted);margin-bottom:14px;">üïí ${r.schedule} ¬∑ üë• –¥–æ ${r.capacity} —á–µ–ª.</p>
                <div class="branch-select-label">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                <div class="branch-options">${branchOpts}</div>
            </div>
        `;
        container.appendChild(card);
    });
}

async function toggleFavorite(restaurantId, e) {
    e.stopPropagation();
    if(!currentUser) { showToast('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'); return; }
    try {
        const res = await fetch('/favorites/toggle', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ user_id: currentUser.id, restaurant_id: restaurantId })
        });
        const data = await res.json();
        currentUser.favorites = data.favorites;
        showToast(data.added ? '‚ù§Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : 'ü§ç –£–¥–∞–ª–µ–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        filterRestaurants();
        if(document.getElementById('favorites').classList.contains('active')) loadFavorites();
    } catch(e) { console.error(e); }
}

async function selectBranchAndBook(restaurantId, branchId, e) {
    e.stopPropagation();
    if(!currentUser) { showToast('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'); showSection('login'); return; }
    try {
        const res = await fetch(`/restaurants/${restaurantId}`);
        currentRestaurant = await res.json();
        currentBranchId = branchId;
        selectedFloor = 1; selectedTables = []; menuQuantities = {};

        const branch = currentRestaurant.branches.find(b => b.id === branchId);
        document.getElementById('booking-title').textContent = `–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ${currentRestaurant.name}`;
        document.getElementById('booking-branch-info').textContent = branch ? `üìç ${branch.address} ¬∑ ${branch.district}` : '';

        const dateInput = document.getElementById('booking-date');
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today; dateInput.value = today;

        const timeSelect = document.getElementById('booking-time');
        timeSelect.innerHTML = '';
        for(let h = 9; h <= 22; h++) {
            ['00','30'].forEach(m => {
                if(h===22 && m==='30') return;
                const opt = document.createElement('option');
                opt.value = opt.textContent = `${h.toString().padStart(2,'0')}:${m}`;
                timeSelect.appendChild(opt);
            });
        }
        renderFloorPlan();
        showSection('booking');
    } catch(err) { console.error(err); }
}

const floorPlans = {
    1: {
        1: [
            {id:'1-1',x:50,y:50,seats:4,type:'square'},{id:'1-2',x:200,y:50,seats:4,type:'square'},
            {id:'1-3',x:350,y:50,seats:6,type:'rectangle'},{id:'1-4',x:50,y:200,seats:4,type:'square'},
            {id:'1-5',x:200,y:200,seats:4,type:'square'},{id:'1-6',x:350,y:200,seats:6,type:'rectangle'},
            {id:'1-7',x:50,y:350,seats:8,type:'rectangle'},{id:'1-8',x:250,y:350,seats:10,type:'rectangle'},
            {id:'1-9',x:500,y:50,seats:4,type:'round',isVIP:true},{id:'1-10',x:500,y:200,seats:6,type:'round',isVIP:true}
        ],
        2: [
            {id:'2-1',x:60,y:60,seats:4,type:'square'},{id:'2-2',x:220,y:60,seats:4,type:'square'},
            {id:'2-3',x:380,y:60,seats:6,type:'rectangle'},{id:'2-4',x:60,y:220,seats:4,type:'square'},
            {id:'2-5',x:220,y:220,seats:8,type:'rectangle'},{id:'2-6',x:60,y:380,seats:6,type:'rectangle'},
            {id:'2-7',x:280,y:380,seats:10,type:'rectangle'},{id:'2-8',x:520,y:100,seats:6,type:'round',isVIP:true},
            {id:'2-9',x:520,y:280,seats:4,type:'round'},{id:'2-10',x:520,y:420,seats:4,type:'round'}
        ]
    },
    2: {
        1: [
            {id:'1-1',x:40,y:40,seats:4,type:'square'},{id:'1-2',x:180,y:40,seats:6,type:'rectangle'},
            {id:'1-3',x:360,y:40,seats:4,type:'square'},{id:'1-4',x:500,y:40,seats:6,type:'rectangle'},
            {id:'1-5',x:40,y:200,seats:8,type:'rectangle'},{id:'1-6',x:300,y:200,seats:10,type:'rectangle'},
            {id:'1-7',x:40,y:380,seats:4,type:'square'},{id:'1-8',x:180,y:380,seats:4,type:'square'},
            {id:'1-9',x:320,y:380,seats:6,type:'round',isVIP:true},{id:'1-10',x:520,y:300,seats:8,type:'round',isVIP:true}
        ],
        2: [
            {id:'2-1',x:50,y:50,seats:4,type:'square'},{id:'2-2',x:200,y:50,seats:4,type:'square'},
            {id:'2-3',x:350,y:50,seats:6,type:'rectangle'},{id:'2-4',x:500,y:50,seats:4,type:'square'},
            {id:'2-5',x:50,y:220,seats:10,type:'rectangle'},{id:'2-6',x:350,y:220,seats:8,type:'rectangle'},
            {id:'2-7',x:50,y:400,seats:6,type:'rectangle'},{id:'2-8',x:280,y:400,seats:4,type:'square'},
            {id:'2-9',x:450,y:400,seats:6,type:'round',isVIP:true},{id:'2-10',x:620,y:220,seats:4,type:'round'}
        ]
    },
    3: {
        1: [
            {id:'1-1',x:60,y:60,seats:4,type:'square'},{id:'1-2',x:220,y:60,seats:4,type:'square'},
            {id:'1-3',x:380,y:60,seats:6,type:'rectangle'},{id:'1-4',x:60,y:240,seats:8,type:'rectangle'},
            {id:'1-5',x:320,y:240,seats:10,type:'rectangle'},{id:'1-6',x:60,y:420,seats:4,type:'square'},
            {id:'1-7',x:220,y:420,seats:6,type:'rectangle'},{id:'1-8',x:540,y:100,seats:6,type:'round',isVIP:true},
            {id:'1-9',x:540,y:280,seats:8,type:'round',isVIP:true},{id:'1-10',x:540,y:440,seats:4,type:'round'}
        ]
    }
};

function renderFloorPlan() {
    const tabsDiv = document.getElementById('floor-tabs');
    tabsDiv.innerHTML = '';
    for(let i = 1; i <= currentRestaurant.floors; i++) {
        const tab = document.createElement('button');
        tab.className = 'floor-tab' + (i===selectedFloor ? ' active' : '');
        tab.textContent = `${i}-–π —ç—Ç–∞–∂`;
        tab.onclick = () => { selectedFloor = i; renderFloorPlan(); };
        tabsDiv.appendChild(tab);
    }
    renderTables();
}

function renderTables() {
    const container = document.getElementById('tables-container');
    container.innerHTML = '';
    const plan = floorPlans[currentRestaurant.id]?.[selectedFloor] || [];

    if(selectedFloor === 1) {
        const w = document.createElement('div');
        w.className = 'window-marker';
        w.style.cssText = 'top:10px;right:20px;';
        w.textContent = 'ü™ü –û–∫–Ω–æ';
        container.appendChild(w);
    }

    plan.forEach(table => {
        const el = document.createElement('div');
        el.className = 'table-item';
        if(selectedTables.includes(table.id)) el.classList.add('selected');
        if(occupiedTables.includes(table.id)) el.classList.add('occupied');
        if(table.isVIP) el.classList.add('vip');
        el.style.cssText = `left:${table.x}px;top:${table.y}px;`;

        const size = table.seats<=4 ? 80 : table.seats<=6 ? 100 : 120;
        const radius = table.type==='round' ? '50%' : table.type==='rectangle' ? '12px' : '8px';
        el.onclick = () => toggleTableSelection(table.id);
        el.innerHTML = `
            <div class="table-visual">
                <div class="table-shape" style="width:${size}px;height:${table.type==='rectangle'?size*0.6:size}px;border-radius:${radius};">
                    <div style="text-align:center;">
                        <div style="font-size:18px;">${table.id.split('-')[1]}</div>
                        <div style="font-size:11px;opacity:0.8;">${table.seats} –º–µ—Å—Ç</div>
                        ${table.isVIP ? '<div style="font-size:10px;">‚≠ê VIP</div>' : ''}
                    </div>
                </div>
            </div>
        `;
        container.appendChild(el);
    });
    updateSelectedTablesDisplay();
}

function toggleTableSelection(tableId) {
    if(occupiedTables.includes(tableId)) { showToast('–≠—Ç–æ—Ç —Å—Ç–æ–ª–∏–∫ —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω'); return; }
    const idx = selectedTables.indexOf(tableId);
    if(idx > -1) selectedTables.splice(idx, 1);
    else selectedTables.push(tableId);
    renderTables();
}

function updateSelectedTablesDisplay() {
    const div = document.getElementById('selected-tables-info');
    if(!selectedTables.length) { div.innerHTML = ''; return; }
    const plan = floorPlans[currentRestaurant.id]?.[selectedFloor] || [];
    const totalSeats = selectedTables.reduce((s,tid) => s+(plan.find(t=>t.id===tid)?.seats||0), 0);
    const hasVIP = selectedTables.some(tid => plan.find(t=>t.id===tid)?.isVIP);
    div.innerHTML = `
        <div class="selected-tables-display">
            <h4 style="margin-bottom:8px;">–í—ã–±—Ä–∞–Ω–æ —Å—Ç–æ–ª–∏–∫–æ–≤: ${selectedTables.length}</h4>
            <div>${selectedTables.map(t=>`<span class="selected-table-tag">–°—Ç–æ–ª ${t.split('-')[1]}</span>`).join('')}</div>
            <p style="margin-top:12px;font-size:14px;">–í—Å–µ–≥–æ –º–µ—Å—Ç: ${totalSeats} ${hasVIP ? '¬∑ ‚≠ê –í–∫–ª—é—á–∞–µ—Ç VIP' : ''}</p>
        </div>
    `;
}

function proceedToMenu() {
    if(!selectedTables.length) {
        document.getElementById('booking-alert').innerHTML = '<div class="alert alert-error">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å—Ç–æ–ª–∏–∫</div>';
        return;
    }
    document.getElementById('booking-alert').innerHTML = '';
    document.getElementById('menu-restaurant-name').textContent = currentRestaurant.name;
    currentMenuCategory = 'all';

    const cats = ['all', ...new Set(currentRestaurant.menu.map(m => m.category))];
    document.getElementById('menu-categories').innerHTML = cats.map(c =>
        `<button class="cat-btn ${c===currentMenuCategory?'active':''}" onclick="setMenuCategory('${c}')">${c==='all'?'–í—Å–µ':c}</button>`
    ).join('');

    renderMenuItems();
    showSection('menu-selection');
}

function setMenuCategory(cat) {
    currentMenuCategory = cat;
    document.querySelectorAll('.cat-btn').forEach(b => {
        b.classList.toggle('active', b.textContent === (cat==='all' ? '–í—Å–µ' : cat));
    });
    renderMenuItems();
}

function renderMenuItems() {
    const grid = document.getElementById('menu-grid');
    grid.innerHTML = '';
    const items = currentMenuCategory === 'all'
        ? currentRestaurant.menu
        : currentRestaurant.menu.filter(m => m.category === currentMenuCategory);

    items.forEach(item => {
        const qty = menuQuantities[item.id] || 0;
        const el = document.createElement('div');
        el.className = 'menu-item' + (qty > 0 ? ' in-cart' : '');
        el.innerHTML = `
            <div class="menu-item-image"><img src="${item.image_url}" alt="${item.name}" loading="lazy"></div>
            <div class="menu-item-content">
                <h4>${item.name}</h4>
                <div class="menu-item-category">${item.category}</div>
                <p style="font-size:14px;color:var(--text-secondary);">${item.description}</p>
                <div class="menu-item-price">${item.price.toLocaleString()} ‚Ç∏</div>
                ${qty > 0 ? `
                <div class="qty-control">
                    <button class="qty-btn" onclick="changeQty(${item.id},-1)">‚àí</button>
                    <span class="qty-count">${qty}</span>
                    <button class="qty-btn" onclick="changeQty(${item.id},1)">+</button>
                </div>` : `
                <button class="btn-add-menu" onclick="changeQty(${item.id},1)">+ –î–æ–±–∞–≤–∏—Ç—å</button>`}
            </div>
        `;
        grid.appendChild(el);
    });
    updateOrderSummary();
}

function changeQty(itemId, delta) {
    const cur = menuQuantities[itemId] || 0;
    const nw = Math.max(0, cur + delta);
    if(nw === 0) delete menuQuantities[itemId];
    else menuQuantities[itemId] = nw;
    renderMenuItems();
}

function updateOrderSummary() {
    const box = document.getElementById('order-summary');
    const lines = document.getElementById('order-lines');
    const ids = Object.keys(menuQuantities).map(Number);
    if(!ids.length) { box.style.display = 'none'; return; }
    box.style.display = 'block';
    let total = 0, html = '';
    ids.forEach(id => {
        const item = currentRestaurant.menu.find(m => m.id === id);
        if(!item) return;
        const qty = menuQuantities[id], sub = item.price * qty;
        total += sub;
        html += `<div class="order-line"><span>${item.name} √ó ${qty}</span><span style="font-weight:600;">${sub.toLocaleString()} ‚Ç∏</span></div>`;
    });
    html += `<div class="order-line"><span>–ò—Ç–æ–≥–æ</span><span style="color:var(--accent);">${total.toLocaleString()} ‚Ç∏</span></div>`;
    lines.innerHTML = html;
}

async function confirmBooking() {
    const date = document.getElementById('booking-date').value;
    const time = document.getElementById('booking-time').value;
    const guests = parseInt(document.getElementById('booking-guests').value);
    const comment = document.getElementById('booking-comment').value || '';

    const plan = floorPlans[currentRestaurant.id]?.[selectedFloor] || [];
    const hasVIP = selectedTables.some(tid => plan.find(t=>t.id===tid)?.isVIP);

    const menuItemIds = Object.keys(menuQuantities).map(Number);
    const mqObj = {};
    menuItemIds.forEach(id => { mqObj[String(id)] = menuQuantities[id]; });

    let totalPrice = 0;
    menuItemIds.forEach(id => {
        const item = currentRestaurant.menu.find(m => m.id === id);
        if(item) totalPrice += item.price * menuQuantities[id];
    });

    try {
        const res = await fetch('/bookings', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                user_id: currentUser.id, restaurant_id: currentRestaurant.id,
                branch_id: currentBranchId, date, time, guests, comment,
                floor: selectedFloor, tables: selectedTables,
                is_vip: hasVIP, menu_items: menuItemIds, menu_quantities: mqObj
            })
        });
        if(!res.ok) { showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'); return; }
        await res.json();
        selectedTables.forEach(t => occupiedTables.push(t));

        const branch = currentRestaurant.branches.find(b => b.id === currentBranchId);
        let menuHtml = '';
        if(menuItemIds.length) {
            menuHtml += `<p style="margin:8px 0;"><strong>–ü—Ä–µ–¥–∑–∞–∫–∞–∑:</strong></p>`;
            menuItemIds.forEach(id => {
                const item = currentRestaurant.menu.find(m => m.id === id);
                if(item) menuHtml += `<p style="margin:4px 0 4px 14px;font-size:13px;color:var(--text-secondary);">‚Ä¢ ${item.name} √ó${menuQuantities[id]} = ${(item.price*menuQuantities[id]).toLocaleString()} ‚Ç∏</p>`;
            });
            menuHtml += `<p style="margin:8px 0;"><strong>–ò—Ç–æ–≥–æ:</strong> <span style="color:var(--accent);font-weight:700;">${totalPrice.toLocaleString()} ‚Ç∏</span></p>`;
        }

        document.getElementById('confirmation-details').innerHTML = `
            <p style="margin:8px 0;"><strong>–†–µ—Å—Ç–æ—Ä–∞–Ω:</strong> ${currentRestaurant.name}</p>
            <p style="margin:8px 0;"><strong>–ê–¥—Ä–µ—Å:</strong> ${branch?.address || ''}</p>
            <p style="margin:8px 0;"><strong>–î–∞—Ç–∞:</strong> ${date}</p>
            <p style="margin:8px 0;"><strong>–í—Ä–µ–º—è:</strong> ${time}</p>
            <p style="margin:8px 0;"><strong>–≠—Ç–∞–∂:</strong> ${selectedFloor}-–π</p>
            <p style="margin:8px 0;"><strong>–°—Ç–æ–ª–∏–∫–∏:</strong> ${selectedTables.map(t=>'‚Ññ'+t.split('-')[1]).join(', ')}</p>
            <p style="margin:8px 0;"><strong>–ì–æ—Å—Ç–µ–π:</strong> ${guests}</p>
            ${hasVIP ? '<p style="margin:8px 0;color:var(--warning);"><strong>‚≠ê VIP —Å—Ç–æ–ª–∏–∫</strong></p>' : ''}
            ${menuHtml}
            ${comment ? `<p style="margin:8px 0;"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${comment}</p>` : ''}
        `;
        showSection('confirmation');
        menuQuantities = {}; selectedTables = [];
    } catch(e) { showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏'); }
}

async function deleteBooking(bookingId) {
    if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) return;

    try {
        const res = await fetch(`/bookings/${bookingId}?user_id=${currentUser.id}`, {
            method: 'DELETE'
        });

        if (!res.ok) {
            const err = await res.json();
            showToast(err.detail || '‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
            return;
        }

        const data = await res.json();
        showToast('‚úì –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–æ');
        loadHistory(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    } catch(e) {
        showToast('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
        console.error(e);
    }
}

async function loadHistory() {
    try {
        const res = await fetch(`/bookings/user/${currentUser.id}`);
        const userBookings = await res.json();
        const list = document.getElementById('history-list');

        if(!userBookings.length) {
            list.innerHTML = '<div class="card" style="text-align:center;padding:60px;"><div style="font-size:48px;margin-bottom:16px;">üìã</div><p style="color:var(--text-muted);">–ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</p></div>';
            return;
        }

        list.innerHTML = userBookings.map(b => {
            const rest = allRestaurants.find(r => r.id === b.restaurant_id);
            const today = new Date().toISOString().split('T')[0];
            const isUpcoming = b.date >= today;
            const tag = isUpcoming
                ? '<span class="booking-tag tag-upcoming">–ü—Ä–µ–¥—Å—Ç–æ–∏—Ç</span>'
                : '<span class="booking-tag tag-past">–ü—Ä–æ—à–ª–æ</span>';

            let menuLine = '';
            if(b.menu_items?.length && rest) {
                const names = b.menu_items.map(id => {
                    const item = rest.menu.find(m => m.id === id);
                    const qty = b.menu_quantities?.[String(id)] || 1;
                    return item ? `${item.name} √ó${qty}` : '';
                }).filter(Boolean);
                if(names.length) menuLine = `<p style="margin-top:6px;font-size:13px;color:var(--text-muted);">üçΩ ${names.join(', ')}</p>`;
            }

            return `
                <div class="booking-card">
                    <div class="booking-card-top">
                        <div>
                            <div class="booking-card-title">${b.restaurant_name || rest?.name || '–†–µ—Å—Ç–æ—Ä–∞–Ω'}</div>
                            <div style="font-size:13px;color:var(--text-muted);">üìç ${b.branch_address || ''}</div>
                        </div>
                        ${tag}
                    </div>
                    <p style="color:var(--text-secondary);font-size:14px;">
                        üìÖ ${b.date} –≤ ${b.time} &nbsp;¬∑&nbsp; üë• ${b.guests} –≥–æ—Å—Ç–µ–π<br>
                        üè¢ ${b.floor}-–π —ç—Ç–∞–∂ &nbsp;¬∑&nbsp; ü™ë ${b.tables.map(t=>'‚Ññ'+t.split('-')[1]).join(', ')}
                        ${b.is_vip ? ' &nbsp;¬∑&nbsp; ‚≠ê VIP' : ''}
                        ${b.total_price > 0 ? `<br>üí∞ –ü—Ä–µ–¥–∑–∞–∫–∞–∑: ${b.total_price.toLocaleString()} ‚Ç∏` : ''}
                    </p>
                    ${menuLine}
                    <div style="margin-top:12px; display: flex; gap: 10px; justify-content: flex-end;">
                        ${b.can_delete ?
                            `<button class="delete-btn" onclick="deleteBooking(${b.id})">üóë –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å</button>` :
                            `<button class="btn btn-secondary" style="font-size:13px;padding:8px 18px;" disabled>‚ùå –ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å</button>`
                        }
                        ${!isUpcoming ? `<button class="btn btn-secondary" style="font-size:13px;padding:8px 18px;" onclick="repeatBooking(${b.id})">üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –±—Ä–æ–Ω—å</button>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    } catch(e) {
        console.error(e);
        document.getElementById('history-list').innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
    }
}

async function repeatBooking(bookingId) {
    try {
        const res = await fetch(`/bookings/user/${currentUser.id}`);
        const bookings = await res.json();
        const b = bookings.find(bk => bk.id === bookingId);
        if(!b) return;

        const restRes = await fetch(`/restaurants/${b.restaurant_id}`);
        currentRestaurant = await restRes.json();
        currentBranchId = b.branch_id;
        selectedFloor = b.floor;
        selectedTables = []; menuQuantities = {};
        b.menu_items?.forEach(id => { menuQuantities[id] = b.menu_quantities?.[String(id)] || 1; });

        const branch = currentRestaurant.branches.find(br => br.id === b.branch_id);
        document.getElementById('booking-title').textContent = `–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ${currentRestaurant.name}`;
        document.getElementById('booking-branch-info').textContent = branch ? `üìç ${branch.address} ¬∑ ${branch.district}` : '';

        const dateInput = document.getElementById('booking-date');
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today; dateInput.value = today;

        const timeSelect = document.getElementById('booking-time');
        timeSelect.innerHTML = '';
        for(let h = 9; h <= 22; h++) {
            ['00','30'].forEach(m => {
                if(h===22 && m==='30') return;
                const opt = document.createElement('option');
                opt.value = opt.textContent = `${h.toString().padStart(2,'0')}:${m}`;
                if(opt.value === b.time) opt.selected = true;
                timeSelect.appendChild(opt);
            });
        }
        const gs = document.getElementById('booking-guests');
        for(const o of gs.options) { if(parseInt(o.value) === b.guests) o.selected = true; }
        document.getElementById('booking-comment').value = '';

        renderFloorPlan();
        showSection('booking');
        showToast('‚úì –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—à–ª–æ–π –±—Ä–æ–Ω–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã');
    } catch(e) { console.error(e); }
}

async function loadFavorites() {
    if(currentUser?.favorites?.length) {
        const favs = allRestaurants.filter(r => currentUser.favorites.includes(r.id));
        if(favs.length) { displayRestaurants(favs, 'favorites-list'); return; }
    }
    document.getElementById('favorites-list').innerHTML =
        '<p style="text-align:center;padding:40px;color:var(--text-secondary);">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</p>';
}

async function loadProfile() {
    try {
        const res = await fetch(`/bookings/user/${currentUser.id}`);
        const userBookings = await res.json();
        const totalSpent = userBookings.reduce((s, b) => s + (b.total_price || 0), 0);
        document.getElementById('profile-info').innerHTML = `
            <div class="profile-avatar">${currentUser.name.charAt(0).toUpperCase()}</div>
            <div style="text-align:center;">
                <h3 style="font-size:24px;font-weight:700;">${currentUser.name}</h3>
                <p style="color:var(--text-secondary);margin-top:4px;">${currentUser.email || currentUser.phone || ''}</p>
            </div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-val">${userBookings.length}</div><div class="stat-lbl">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div></div>
                <div class="stat-box"><div class="stat-val">${currentUser.favorites?.length || 0}</div><div class="stat-lbl">–ò–∑–±—Ä–∞–Ω–Ω—ã—Ö</div></div>
            </div>
            <div style="background:var(--bg);padding:20px;border-radius:12px;margin-top:16px;">
                ${currentUser.phone ? `<p style="margin:8px 0;"><strong>üì± –¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${currentUser.phone}</p>` : ''}
                ${currentUser.email ? `<p style="margin:8px 0;"><strong>‚úâÔ∏è Email:</strong> ${currentUser.email}</p>` : ''}
                ${totalSpent > 0 ? `<p style="margin:8px 0;"><strong>üí∞ –°—É–º–º–∞ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–æ–≤:</strong> ${totalSpent.toLocaleString()} ‚Ç∏</p>` : ''}
            </div>
        `;
    } catch(e) { console.error(e); }
}

if(currentUser) { setLoggedIn(true); loadRestaurants(); }
</script>
</body>
</html>