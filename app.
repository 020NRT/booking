from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from pydantic import BaseModel
from typing import List

app = FastAPI()

# --- CORS ---
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- –ú–æ–¥–µ–ª–∏ ---
class User(BaseModel):
    id: int
    name: str
    phone: str
    favorites: List[int] = []

class Restaurant(BaseModel):
    id: int
    name: str
    description: str
    address: str
    schedule: str
    capacity: int
    image_url: str

class Booking(BaseModel):
    id: int
    user_id: int
    restaurant_id: int
    date: str
    time: str
    guests: int
    comment: str

class BookingCreate(BaseModel):
    user_id: int
    restaurant_id: int
    date: str
    time: str
    guests: int
    comment: str

class UserCreate(BaseModel):
    name: str
    phone: str

# --- "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö" ---
users: List[User] = []
restaurants: List[Restaurant] = [
    Restaurant(id=1, name="–ö–æ—Ñ–µ–π–Ω—è Aroma", description="–£—é—Ç–Ω–∞—è –∫–æ—Ñ–µ–π–Ω—è –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞.", address="—É–ª. –ê–±–∞—è, 10", schedule="09:00-23:00", capacity=30, image_url="https://via.placeholder.com/400x200"),
    Restaurant(id=2, name="Restaurant Luna", description="–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å –µ–≤—Ä–æ–ø–µ–π—Å–∫–æ–π –∫—É—Ö–Ω–µ–π.", address="—É–ª. –î–æ—Å—Ç—ã–∫, 5", schedule="10:00-22:00", capacity=50, image_url="https://via.placeholder.com/400x200"),
]
bookings: List[Booking] = []

next_user_id = 1
next_booking_id = 1

# --- HTML ---
html_content = """
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–û–Ω–ª–∞–π–Ω-–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
<style>
:root{--bg:#f0f1f5;--card:#fff;--primary:#1f2937;--accent:#3b82f6;--accent-dark:#2563eb;--muted:#6b7280;--success:#16a34a;--shadow:rgba(0,0,0,0.08);}
*{box-sizing:border-box;font-family:'Inter',sans-serif;margin:0;padding:0;}
body{background:var(--bg);color:var(--primary);}
header{background:var(--card);box-shadow:0 2px 8px var(--shadow);padding:20px;text-align:center;position:fixed;width:100%;top:0;z-index:10;}
header h1{margin:0;font-size:24px;}
nav{display:flex;justify-content:center;gap:16px;margin-top:10px;}
nav button{padding:10px 16px;border-radius:12px;border:none;background:#e5e7eb;cursor:pointer;transition:.2s;}
nav button.active,nav button:hover{background:var(--accent);color:#fff;}
.container{max-width:1000px;margin:100px auto 24px;padding:0 16px;}
.section{display:none;animation:fadeIn .3s ease;}
.section.active{display:block;}
.card{background:var(--card);border-radius:18px;padding:20px;box-shadow:0 8px 24px var(--shadow);margin-bottom:24px;transition:transform .2s ease,box-shadow .2s ease;}
.card:hover{transform:translateY(-3px);box-shadow:0 12px 28px var(--shadow);}
.card img{width:100%;border-radius:16px;object-fit:cover;}
.card h2,.card h3{margin:10px 0 8px;}
.meta{font-size:14px;color:var(--muted);margin-bottom:12px;}
input,select,textarea{width:100%;margin:6px 0 16px;padding:14px;border-radius:12px;border:1px solid #e5e7eb;font-size:15px;background:#fff;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,0.2);}
button.submit{padding:14px 20px;border-radius:12px;border:none;font-size:16px;font-weight:500;cursor:pointer;background:var(--accent);color:#fff;transition:.2s;}
button.submit:hover{background:var(--accent-dark);}
.filters{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px;}
.filters select,.filters input{flex:1;min-width:120px;}
.confirmation{text-align:center;padding:40px 20px;}
.confirmation h2{font-size:24px;color:var(--success);margin-bottom:16px;}
.confirmation .details{background:#f3f4f6;padding:16px;border-radius:12px;margin:16px 0;text-align:left;box-shadow:0 4px 12px var(--shadow);}
.confirmation .details p{margin:6px 0;}
.input-wrapper {position: relative; display: block; cursor: pointer;}
.input-wrapper input, .input-wrapper select {width:100%; cursor:pointer;}
.restaurant-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px;}
.heart{float:right;font-size:20px;cursor:pointer;color:var(--muted);}
.heart.active{color:red;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@media(max-width:600px){header h1{font-size:20px;}.card{padding:18px;}.filters{flex-direction:column;}}
</style>
</head>
<body>
<header>
<h1>üçΩ –û–Ω–ª–∞–π–Ω-–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
<nav id="tabs" style="display:none;">
<button onclick="showTab('home')" class="active">–ì–ª–∞–≤–Ω–∞—è</button>
<button onclick="showTab('history')">–ò—Å—Ç–æ—Ä–∏—è</button>
<button onclick="showTab('favorites')">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
<button onclick="showTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
</nav>
</header>

<div class="container">

<!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="welcome" class="section active">
    <div class="card">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
        <p>–û–Ω–ª–∞–π–Ω-–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–æ–≤ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö –∏ –∫–∞—Ñ–µ.</p>
        <button class="submit" onclick="show('register')">–ù–∞—á–∞—Ç—å</button>
    </div>
</div>

<!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
<div id="register" class="section">
    <div class="card">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input id="name" placeholder="–í–∞—à–µ –∏–º—è">
        <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        <button class="submit" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </div>
</div>

<!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
<div id="home" class="section">
    <div class="filters">
        <input id="search" placeholder="–ü–æ–∏—Å–∫">
        <select id="filter-district"><option>–í—Å–µ —Ä–∞–π–æ–Ω—ã</option><option>–¶–µ–Ω—Ç—Ä</option><option>–ú–µ–¥–µ—É</option></select>
        <select id="filter-cuisine"><option>–í—Å–µ –∫—É—Ö–Ω–∏</option><option>–ö–∞—Ñ–µ</option><option>–ï–≤—Ä–æ–ø–µ–π—Å–∫–∞—è</option></select>
        <select id="filter-open"><option>–í—Å–µ</option><option>–û—Ç–∫—Ä—ã—Ç–æ —Å–µ–π—á–∞—Å</option></select>
    </div>
    <div class="restaurant-list" id="restaurant-list"></div>
</div>

<!-- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
<div id="booking" class="section">
    <div class="card">
        <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
        <label>–î–∞—Ç–∞</label>
        <div class="input-wrapper" onclick="dateInput.focus()">
            <input type="date" id="booking-date">
        </div>
        <label>–í—Ä–µ–º—è</label>
        <div class="input-wrapper" onclick="timeSelect.focus()">
            <select id="booking-time"></select>
        </div>
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label>
        <select id="booking-guests"><option>1</option><option>2</option><option>3</option><option>4</option><option>5+</option></select>
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="booking-comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É –æ–∫–Ω–∞"></textarea>
        <button class="submit" onclick="confirmBooking()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="secondary" onclick="show('home')">–ù–∞–∑–∞–¥</button>
    </div>
</div>

<!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -->
<div id="confirmation" class="section">
    <div class="card confirmation">
        <h2>‚úÖ –ë—Ä–æ–Ω—å –ø—Ä–∏–Ω—è—Ç–∞!</h2>
        <div class="details">
            <p><strong>–†–µ—Å—Ç–æ—Ä–∞–Ω:</strong> <span id="conf-rest"></span></p>
            <p><strong>–î–∞—Ç–∞:</strong> <span id="conf-date"></span></p>
            <p><strong>–í—Ä–µ–º—è:</strong> <span id="conf-time"></span></p>
            <p><strong>–ì–æ—Å—Ç–µ–π:</strong> <span id="conf-guests"></span></p>
            <p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> <span id="conf-comment"></span></p>
        </div>
        <button class="submit" onclick="show('home')">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    </div>
</div>

<!-- –ò—Å—Ç–æ—Ä–∏—è -->
<div id="history" class="section">
    <div class="card">
        <h2>–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h2>
        <div id="history-list"></div>
    </div>
</div>

<!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
<div id="favorites" class="section">
    <div class="card">
        <h2>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
        <div id="favorites-list"></div>
    </div>
</div>

<!-- –ü—Ä–æ—Ñ–∏–ª—å -->
<div id="profile" class="section">
    <div class="card">
        <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
        <p id="profile-info"></p>
    </div>
</div>

</div>

<script>
let currentUser = null;
let currentRestaurant = null;

// --- –°–µ–∫—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ ---
function showTab(tab){
    document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
    document.querySelector(`#tabs button[onclick="showTab('${tab}')"]`).classList.add('active');
    show(tab);
}

function show(id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id==='history') loadHistory();
    if(id==='favorites') loadFavorites();
    if(id==='profile') loadProfile();
}

// --- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ---
function register(){
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    if(!name||!phone){ alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è"); return; }
    fetch("/users",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({name, phone})
    }).then(res=>res.json()).then(data=>{
        currentUser = data;
        document.getElementById('tabs').style.display = "flex";
        loadRestaurants();
        show('home');
    });
}

// --- –†–µ—Å—Ç–æ—Ä–∞–Ω—ã ---
async function loadRestaurants(){
    const res = await fetch("/restaurants");
    const data = await res.json();
    const list = document.getElementById('restaurant-list');
    list.innerHTML = "";
    data.forEach(r=>{
        const card = document.createElement('div');
        card.className="card";
        const heartClass = currentUser && currentUser.favorites.includes(r.id) ? "heart active" : "heart";
        card.innerHTML=`
            <span class="${heartClass}" onclick="toggleFavorite(${r.id}, this)">&#10084;</span>
            <img src="${r.image_url}">
            <h3>${r.name}</h3>
            <p class="meta">${r.address}</p>
            <button onclick="openRestaurant(${r.id})">–û—Ç–∫—Ä—ã—Ç—å</button>
        `;
        list.appendChild(card);
    });
}

// --- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ ---
function toggleFavorite(id, el){
    if(currentUser.favorites.includes(id)){
        currentUser.favorites = currentUser.favorites.filter(f=>f!==id);
        el.classList.remove("active");
    } else {
        currentUser.favorites.push(id);
        el.classList.add("active");
    }
    loadFavorites();
}

function loadFavorites(){
    const list = document.getElementById('favorites-list');
    list.innerHTML="";
    fetch("/restaurants").then(res=>res.json()).then(data=>{
        data.filter(r=>currentUser.favorites.includes(r.id)).forEach(r=>{
            const card=document.createElement('div');
            card.className="card";
            card.innerHTML=`<img src="${r.image_url}"><h3>${r.name}</h3><p>${r.address}</p>`;
            list.appendChild(card);
        });
    });
}

// --- –û—Ç–∫—Ä—ã—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω ---
async function openRestaurant(id){
    const res = await fetch(`/restaurants/${id}`);
    const r = await res.json();
    currentRestaurant = r;
    document.getElementById('conf-rest').textContent = r.name;
    show('booking');
}

// --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –≤—Ä–µ–º—è ---
const dateInput = document.getElementById('booking-date');
const today = new Date().toISOString().split('T')[0];
dateInput.min = today;
const timeSelect = document.getElementById('booking-time');
function populateTimes(){
    for(let h=9;h<=22;h++){ ["00","30"].forEach(min=>{
        if(h===22&&min==="30") return;
        const option=document.createElement("option");
        option.value=`${h.toString().padStart(2,'0')}:${min}`;
        option.textContent=`${h.toString().padStart(2,'0')}:${min}`;
        timeSelect.appendChild(option);
    }); }
}
populateTimes();

// --- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ---
function confirmBooking(){
    const bookingData = {
        user_id: currentUser.id,
        restaurant_id: currentRestaurant.id,
        date: dateInput.value,
        time: timeSelect.value,
        guests: parseInt(document.getElementById('booking-guests').value),
        comment: document.getElementById('booking-comment').value || "-"
    };
    fetch("/bookings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(bookingData)})
    .then(res=>res.json())
    .then(data=>{
        document.getElementById('conf-date').textContent = data.date;
        document.getElementById('conf-time').textContent = data.time;
        document.getElementById('conf-guests').textContent = data.guests;
        document.getElementById('conf-comment').textContent = data.comment;
        show('confirmation');
    });
}

// --- –ò—Å—Ç–æ—Ä–∏—è ---
function loadHistory(){
    fetch("/bookings").then(res=>res.json()).then(data=>{
        const list=document.getElementById('history-list');
        list.innerHTML="";
        data.filter(b=>b.user_id===currentUser.id).forEach(b=>{
            const item=document.createElement('p');
            const restaurant = restaurants.find(r=>r.id===b.restaurant_id);
            const name = restaurant ? restaurant.name : `ID ${b.restaurant_id}`;
            item.textContent=`${b.date} ${b.time} - ${name}, –≥–æ—Å—Ç–µ–π: ${b.guests}`;
            list.appendChild(item);
        });
    });
}

// --- –ü—Ä–æ—Ñ–∏–ª—å ---
function loadProfile(){
    document.getElementById('profile-info').textContent=`–ò–º—è: ${currentUser.name}, –¢–µ–ª–µ—Ñ–æ–Ω: ${currentUser.phone}`;
}

</script>

</body>
</html>
"""

# --- Endpoints ---
@app.get("/", response_class=HTMLResponse)
def get_home():
    return HTMLResponse(content=html_content, status_code=200)

# --- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ---
@app.post("/users", response_model=User)
def create_user(u: UserCreate):
    global next_user_id
    user = User(id=next_user_id, name=u.name, phone=u.phone, favorites=[])
    users.append(user)
    next_user_id += 1
    return user

# --- –†–µ—Å—Ç–æ—Ä–∞–Ω—ã ---
@app.get("/restaurants", response_model=List[Restaurant])
def get_restaurants():
    return restaurants

@app.get("/restaurants/{restaurant_id}", response_model=Restaurant)
def get_restaurant(restaurant_id: int):
    for r in restaurants:
        if r.id == restaurant_id:
            return r
    raise HTTPException(status_code=404, detail="–†–µ—Å—Ç–æ—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω")

# --- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ---
@app.post("/bookings", response_model=Booking)
def create_booking(b: BookingCreate):
    global bookings, next_booking_id
    booking = Booking(id=next_booking_id, user_id=b.user_id, restaurant_id=b.restaurant_id,
                      date=b.date, time=b.time, guests=b.guests, comment=b.comment)
    bookings.append(booking)
    next_booking_id += 1
    return booking

@app.get("/bookings", response_model=List[Booking])
def list_bookings():
    return bookings
